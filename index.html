<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Vodafone / National Grid POWRA</title>
<style>
  :root{ --sheet-w: 794px; } /* A4 width at ~96dpi: 8.27in * 96 ≈ 794 */
  html, body { background: #f0f0f0; }
  body { font-family: Arial, sans-serif; margin: 0; padding: 20px 0; }
  #sheet {
    width: var(--sheet-w);
    margin: 0 auto;
    background: #fff;
    padding: 16px;
    box-shadow: 0 0 8px rgba(0,0,0,0.08);
  }
  h1 { text-align: center; margin: 8px 0 6px 0; }
  h2 { margin-top: 18px; margin-bottom: 8px; }
  .header { display: flex; justify-content: space-between; align-items: center; }
  .header img { height: 50px; max-width: 40%; object-fit: contain; }
  .version { text-align: center; font-size: 0.9em; color: #666; margin: 8px 0 16px; }
  table { width: 100%; border-collapse: collapse; margin-bottom: 12px; background: #fff; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; }
  th { background: #eee; width: 32%; }
  textarea { width: 100%; height: 100px; }
  .checkbox-list label { display: block; margin: 4px 0; }
  .signature-pad { border: 1px solid #000; width: 100%; height: 120px; background:#fff; }
  .sig-container { margin-bottom: 12px; }
  button { padding: 8px 14px; margin-top: 5px; }
  button[disabled] { opacity: 0.5; cursor: not-allowed; }
  a.link { display: inline-block; margin-left: 8px; color: blue; text-decoration: underline; }
  .actions { margin-top: 12px; }
  .note { font-size: 0.9em; color:#555; }
  .prompt { font-size: 0.9em; color: #b00020; margin-top: 6px; }
  img { max-width: 100%; height: auto; }

  /* Avoid bad splits in PDF */
  table, .section, .sig-container { break-inside: avoid; page-break-inside: avoid; }
  .header { break-inside: avoid; page-break-inside: avoid; }
  .actions { break-inside: avoid; page-break-inside: avoid; }
</style>
</head>
<body>

<div id="sheet">
  <div class="header">
    <img crossorigin="anonymous" referrerpolicy="no-referrer"
         src="https://upload.wikimedia.org/wikipedia/commons/1/1b/Vodafone_2017_logo.svg" alt="Vodafone">
    <h1>Daily Point of Work Risk Assessment (POWRA)</h1>
    <img crossorigin="anonymous" referrerpolicy="no-referrer"
         src="https://upload.wikimedia.org/wikipedia/commons/7/75/National_Grid_logo.svg" alt="National Grid">
  </div>

  <div class="version">Version 17 • GPS required before download</div>

  <p><strong>Date/Time:</strong> <span id="datetime"></span></p>

  <h2>Job Details</h2>
  <div class="section">
  <table>
    <tr><th>Contract</th><td><input type="text" style="width:100%"></td></tr>
    <tr><th>CBOL Number</th><td><input type="text" style="width:100%"></td></tr>
    <tr><th>Supervisor Name & Contact</th><td><input type="text" style="width:100%"></td></tr>
    <tr>
      <th>CP in charge</th>
      <td>
        <select style="width:100%">
          <option value="">-- Select CP --</option>
          <option>Warren Barron</option>
          <option>Carl Carlisle</option>
          <option>Joe Smith</option>
          <option>Matt Bodrozic</option>
          <option>Bobby Rehman</option>
          <option>Mick Waine</option>
        </select>
      </td>
    </tr>

    <tr>
      <th>GPS Location</th>
      <td>
        <input id="locField" type="text" style="width:80%" readonly placeholder="Press button to fetch">
        <button type="button" onclick="getCoords()">Get Current Location</button>
        <a id="locLink" class="link" href="#" target="_blank" style="display:none;">Open in Google Maps</a>
      </td>
    </tr>

    <tr>
      <th>Work Type</th>
      <td>
        <select style="width:100%">
          <option value="">-- Select Work Type --</option>
          <option>Overhead works</option>
          <option>HV Substation</option>
          <option>Telco Room</option>
          <option>GDC</option>
        </select>
      </td>
    </tr>
  </table>
  </div>

  <h2>Section A – Start Safe</h2>
  <div class="section checkbox-list">
    <label><input type="checkbox"> Correct location confirmed</label>
    <label><input type="checkbox"> Vehicles/plant parked safely</label>
    <label><input type="checkbox"> Job Pack discussed</label>
    <label><input type="checkbox"> Risk Assessments referenced</label>
    <label><input type="checkbox"> Work area inspected for hazards</label>
    <label><input type="checkbox"> Precautions (trees, dust, nests, etc)</label>
    <label><input type="checkbox"> NOC notified</label>
    <label><input type="checkbox"> Permit boards available</label>
    <label><input type="checkbox"> Work area demarcated</label>
    <label><input type="checkbox"> PPE checked</label>
    <label><input type="checkbox"> Tools & plant inspected</label>
    <label><input type="checkbox"> Gas detector checked</label>
    <label><input type="checkbox"> Rescue kit available</label>
    <label><input type="checkbox"> Team members competent</label>
    <label><input type="checkbox"> First Aid / COSHH sheets available</label>
    <label><input type="checkbox"> Pre-start geo-sight images taken</label>
  </div>

  <h2>Section B – Other Significant Info</h2>
  <div class="section">
    <textarea placeholder="Enter site-specific hazards and controls here..."></textarea>
  </div>

  <h2>Section C – Work Safe</h2>
  <div class="section checkbox-list">
    <label><input type="checkbox"> Wayleaves checked</label>
    <label><input type="checkbox"> Correct lifting equipment</label>
    <label><input type="checkbox"> Gas detector in use</label>
    <label><input type="checkbox"> Climbing harness inspected</label>
    <label><input type="checkbox"> Hospital location briefed</label>
    <label><input type="checkbox"> COSHH sheets available</label>
    <label><input type="checkbox"> Site geo-sight images taken</label>
    <label><input type="checkbox"> Vehicles locked & secured</label>
    <label><input type="checkbox"> Team briefed on risks/controls</label>
  </div>

  <h2>Team Signatures</h2>
  <div id="signatures" class="section"></div>
  <button onclick="addSignature()">Add Team Member Signature</button>

  <div class="actions">
    <button id="downloadBtn" type="button" onclick="downloadPDF()" disabled>Download PDF</button>
    <p id="gpsPrompt" class="prompt">⛔ Please enter your GPS Location first to enable the download.</p>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

<script>
document.getElementById("datetime").textContent = new Date().toLocaleString();
function updateDownloadState() {
  const gps = document.getElementById('locField').value.trim();
  const btn = document.getElementById('downloadBtn');
  const prompt = document.getElementById('gpsPrompt');
  const enabled = gps.length > 0;
  btn.disabled = !enabled;
  prompt.style.display = enabled ? 'none' : 'block';
}
document.addEventListener('input', (e) => {
  if (e.target && e.target.id === 'locField') updateDownloadState();
});
function getPosition(opts = { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }) {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) return reject(new Error("Geolocation not supported"));
    navigator.geolocation.getCurrentPosition(resolve, reject, opts);
  });
}
async function getCoords() {
  try {
    const pos = await getPosition();
    const lat = pos.coords.latitude.toFixed(6);
    const lng = pos.coords.longitude.toFixed(6);
    const field = document.getElementById("locField");
    const link  = document.getElementById("locLink");
    field.value = `${lat}, ${lng}`;
    link.href = `https://maps.google.com/?q=${lat},${lng}`;
    link.style.display = "inline";
    updateDownloadState();
  } catch (e) {
    alert("Unable to retrieve location. Check permissions and try again.");
  }
}
let sigCount = 0;
function addSignature() {
  sigCount++;
  const container = document.createElement("div");
  container.className = "sig-container";
  container.innerHTML = `
    <p><strong>Team Member ${sigCount}</strong></p>
    <canvas id="sig${sigCount}" class="signature-pad"></canvas>
    <button type="button" onclick="clearSig(${sigCount})">Clear</button>
  `;
  document.getElementById("signatures").appendChild(container);
  const canvas = document.getElementById("sig" + sigCount);
  const pad = new SignaturePad(canvas);
  canvas.width = canvas.offsetWidth;
  canvas.height = 120;
  pad.clear();
  window["pad" + sigCount] = pad;
}
function clearSig(n) { if (window["pad" + n]) window["pad" + n].clear(); }
function waitForImagesWithTimeout(root=document, timeoutMs=1200) {
  const imgs = Array.from(root.images || []);
  const pend = imgs.filter(img => !img.complete || img.naturalWidth === 0)
    .map(img => new Promise(res => {
      let done=false, finish=()=>{ if(!done){ done=true; res(); } };
      img.addEventListener('load', finish, {once:true});
      img.addEventListener('error', finish, {once:true});
      setTimeout(finish, timeoutMs);
    }));
  return Promise.all(pend);
}
function formatFilenameDDMMYYYY(dateObj=new Date()) {
  const dd = String(dateObj.getDate()).padStart(2,'0');
  const mm = String(dateObj.getMonth()+1).padStart(2,'0');
  const yyyy = dateObj.getFullYear();
  return `POWRA_${dd}_${mm}_${yyyy}.pdf`;
}
async function downloadPDF() {
  try {
    if (typeof html2pdf === 'undefined') {
      alert('PDF engine not loaded. Check connection and try again.'); return;
    }
    const root = document.getElementById('sheet');
    await waitForImagesWithTimeout(root, 1200);
    const filename = formatFilenameDDMMYYYY();
    try {
      await html2pdf().set({
        margin: 5,
        filename: filename,
        pagebreak: { mode: ['css','legacy'] },
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, backgroundColor: '#fff', scrollX: 0, scrollY: 0, windowWidth: 900 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      }).from(root).save();
      return;
    } catch(e1) {}
    try {
      const worker = html2pdf().set({
        margin: 5,
        pagebreak: { mode: ['css','legacy'] },
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, backgroundColor: '#fff', scrollX: 0, scrollY: 0, windowWidth: 900 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      }).from(root).toPdf();
      const pdf = await worker.get('pdf');
      const blob = pdf.output('blob');
      const url = URL.createObjectURL(blob);
      const w = window.open(url, '_blank');
      if (w) return;
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
      return;
    } catch(e2) {}
    window.print();
  } catch (err) { alert('Could not generate PDF. Reload and try again.'); }
}
updateDownloadState();
</script>
</body>
</html>